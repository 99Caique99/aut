<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro da Criança</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="cadastro.css">
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-slate-200" style="display: none;">
    <!-- O corpo da página fica oculto até o Firebase confirmar que o usuário está logado -->

    <main class="relative z-10 w-full max-w-lg mx-auto cartao-entrando my-8">
        <!-- Card com efeito de vidro azulado -->
        <div class="CartaoAzul">
             <a href="index.html" class="absolute top-4 left-4 p-2 rounded-full hover:bg-white/10 transition-colors" title="Voltar ao menu">
                <svg class="w-6 h-6 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <!-- Cabeçalho com Avatar -->
            <div class="Boneco">
                <div class="bgBlue">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-cyan-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h1 class="text">Cadastro da Criança</h1>
            </div>
            
            <!-- Formulário com ícones -->
            <form id="formCadastro" class="space-y-4">
                <div class="relative">
                    <input type="text" id="nome" placeholder="Nome da Criança" required class="w-full pl-10 p-3 bg-white/5 text-slate-100 rounded-lg border border-transparent focus:ring-2 focus:ring-cyan-400 focus:outline-none transition duration-300">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="date" id="dataNascimento" required class="w-full p-3 bg-white/5 text-slate-100 rounded-lg border border-transparent appearance-none focus:ring-2 focus:ring-cyan-400 focus:outline-none transition duration-300">
                    <select id="genero" required class="w-full p-3 bg-white/5 text-slate-100 rounded-lg border border-transparent appearance-none focus:ring-2 focus:ring-cyan-400 focus:outline-none transition duration-300">
                        <option value="" disabled selected>Gênero</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <input type="text" id="diagnostico" placeholder="Diagnóstico (opcional)" class="w-full p-3 bg-white/5 text-slate-100 rounded-lg border border-transparent focus:ring-2 focus:ring-cyan-400 focus:outline-none transition duration-300">
                <textarea id="observacoes" rows="3" placeholder="Observações (opcional)" class="w-full p-3 bg-white/5 text-slate-100 rounded-lg border border-transparent focus:ring-2 focus:ring-cyan-400 focus:outline-none transition duration-300"></textarea>
                <button type="submit" class="w-full p-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-600 text-white rounded-lg font-semibold shadow-lg transition transform hover:scale-105 active:scale-100 duration-300">
                    Salvar Cadastro
                </button>
            </form>
            <div id="info-salva-container" class="pt-6 border-t border-slate-300/10 mt-6"></div>
        </div>
    </main>
    
    <!-- Modal de confirmação para exclusão -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 items-center justify-center p-4">
         <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 max-w-sm w-full text-center cartao-entrando">
            <h2 class="text-xl font-bold text-slate-100 mb-2">Confirmar Exclusão</h2>
            <p class="text-slate-400 mb-6">Tem certeza que deseja apagar permanentemente os dados?</p>
            <div class="flex gap-4">
                <button id="cancelDelete" class="w-full p-2 bg-slate-600 hover:bg-slate-500 text-white rounded-md transition duration-200">Cancelar</button>
                <button id="confirmDelete" class="w-full p-2 bg-red-600 hover:bg-red-500 text-white rounded-md transition duration-200">Excluir</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===================================================================================
        // Suas credenciais do Firebase foram inseridas aqui.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDVZ3yG8dvgbbuym3Yk2OKsSz2sSPfFr3Q",
            authDomain: "autism10-3e151.firebaseapp.com",
            projectId: "autism10-3e151",
            storageBucket: "autism10-3e151.appspot.com",
            messagingSenderId: "423547360033",
            appId: "1:423547360033:web:8253ec498f16951bc12460",
            measurementId: "G-SSMLE8EH3E"
        };
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Verifica o status do login
        onAuthStateChanged(auth, user => {
            if (user) {
                document.body.style.display = 'flex';
                setupPage(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Função principal que roda quando o usuário está logado
        function setupPage(userId) {
            const form = document.getElementById("formCadastro");
            const infoContainer = document.getElementById("info-salva-container");
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            
            // Referência para o documento do usuário no Firestore
            const userDocRef = doc(db, `users/${userId}/profile`, 'childData');

            const closeModal = () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            };

            const calcularIdade = (dataNascimento) => {
                if (!dataNascimento) return 'N/A';
                const hoje = new Date();
                const nascimento = new Date(dataNascimento);
                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const m = hoje.getMonth() - nascimento.getMonth();
                if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) idade--;
                return idade;
            };

            const formatarData = (data) => {
                if (!data) return 'Não informada';
                const [ano, mes, dia] = data.split('-');
                return `${dia}/${mes}/${ano}`;
            }

            const mostrarInfo = async () => {
                try {
                    const docSnap = await getDoc(userDocRef);
                    infoContainer.innerHTML = "";

                    if (docSnap.exists()) {
                        const dados = docSnap.data();
                        const idadeCalculada = calcularIdade(dados.dataNascimento);
                        const dataFormatada = formatarData(dados.dataNascimento);

                        const infoCard = document.createElement("div");
                        infoCard.className = "cartao-entrando bg-blue-900/10 border border-white/10 backdrop-blur-xl rounded-lg p-4 space-y-3";
                        infoCard.innerHTML = `
                            <h2 class="text-xl font-semibold text-center text-slate-200 mb-3">Informações Salvas</h2>
                            <div class="text-left space-y-2 text-slate-300">
                                <p><strong>Nome:</strong> ${dados.nome}</p>
                                <p><strong>Idade:</strong> ${idadeCalculada} anos (Nasc: ${dataFormatada})</p>
                                <p><strong>Gênero:</strong> ${dados.genero || 'Não informado'}</p>
                                <p><strong>Diagnóstico:</strong> ${dados.diagnostico || 'Não informado'}</p>
                                <p><strong>Observações:</strong> ${dados.observacoes || 'Nenhuma'}</p>
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button id="editBtn" class="flex-1 p-2 bg-slate-200/10 hover:bg-slate-200/20 text-slate-200 rounded-md transition text-sm font-semibold">Editar</button>
                                <button id="deleteBtn" class="flex-1 p-2 bg-red-500/70 hover:bg-red-500/90 text-white rounded-md transition text-sm font-semibold">Excluir</button>
                            </div>`;
                        infoContainer.appendChild(infoCard);
                        
                        document.getElementById('editBtn').onclick = () => editar(dados);
                        document.getElementById('deleteBtn').onclick = excluir;

                    } else {
                        infoContainer.innerHTML = `<p class="text-center text-slate-400">Nenhuma informação salva.</p>`;
                    }
                } catch (error) {
                    console.error("Erro ao buscar informações:", error);
                    infoContainer.innerHTML = `<p class="text-center text-red-400">Erro ao carregar dados.</p>`;
                }
            };

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const dados = {
                    nome: document.getElementById("nome").value,
                    dataNascimento: document.getElementById("dataNascimento").value,
                    genero: document.getElementById("genero").value,
                    diagnostico: document.getElementById("diagnostico").value,
                    observacoes: document.getElementById("observacoes").value
                };
                try {
                    await setDoc(userDocRef, dados);
                    mostrarInfo();
                    form.reset();
                } catch(error) {
                    console.error("Erro ao salvar:", error);
                    alert("Não foi possível salvar os dados.");
                }
            });

            const editar = (dados) => {
                if (dados) {
                    document.getElementById("nome").value = dados.nome || '';
                    document.getElementById("dataNascimento").value = dados.dataNascimento || '';
                    document.getElementById("genero").value = dados.genero || '';
                    document.getElementById("diagnostico").value = dados.diagnostico || '';
                    document.getElementById("observacoes").value = dados.observacoes || '';
                    document.getElementById("nome").focus();
                }
            };
            
            const excluir = () => {
                deleteModal.classList.remove('hidden');
                deleteModal.classList.add('flex');
            };

            confirmDeleteBtn.addEventListener('click', async () => {
                try {
                    await deleteDoc(userDocRef);
                    mostrarInfo();
                    closeModal();
                } catch(error) {
                    console.error("Erro ao excluir:", error);
                    alert("Não foi possível excluir os dados.");
                }
            });

            cancelDeleteBtn.addEventListener('click', closeModal);
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) closeModal();
            });

            // Carrega as informações iniciais ao entrar na página
            mostrarInfo();
        }
    </script>
</body>
</html>

